   1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	; Port of Steve Wozniak's Woz Monitor to ETCa
   2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	
   3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	                .include "ss.cfg"
   1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	; Configuration file for AbelianGrape's "Sim Speed" ETCa builds. This file
   2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	; is included by the first line of wozmon.s.
   3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	
   4                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	; Defining SET_VEC would tell wozmon.s that an interrupt vector needs to be
   5                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	; set to cause a reset in the event of a fault. The "Sim Speed" builds don't
   6                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	; support INT, so this doesn't need to be set.
   7                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	; .set SET_VEC, 1
   8                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	
   9                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	; Defining CUSTOM_ECHO would tell wozmon.s to include echo.s (a file which
  10                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	; you can implement to contain a suitable ECHO function for your machine).
  11                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	; See the included echo.s for the Grape1 architecture.
  12                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	
  13                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	; This address, if set, is where wozmon will place any variables that it
  14                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	; needs access to in memory. This space consumes TODO bytes.
  15                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	.set VARS, 0x0010
  16                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	; Instead of VARS, you may set VARS_IN_BSS to have the linker automatically
  17                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	; allocate memory in the .bss segment for the vars. This will almost certainly
  18                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	; require creating a suitable linker script for your machine. An example for
  19                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	; Grape1 is provided. To use a linker script, you must define `LDSCR` in
  20                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	; make.sh to its path.
  21                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	; .set VARS_IN_BSS, 1
  22                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	
  23                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	; These variables define the MMIO addresses for accessing the keyboard.
  24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	; KBDCR produces non-zero if there is a pending key event. KBD reads the
  25                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	; next key event.
  26                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	.set KBDCR, 4
  27                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	.set KBD,   5
  28                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	
  29                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	; This MMIO address writes the given character to the console. 0xA should be
  30                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	; treated as a newline control character.
  31                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	.set DSP,   3
  32                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	; If a custom echo is needed instead, define CUSTOM_ECHO and implement it in
  33                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	; echo.s.
  34                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	; .set CUSTOM_ECHO, 1
   4                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	
   5                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	                .ifdef VARS_IN_BSS
   6                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	                .bss
   7                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	VARS:           .space 8
   8                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	                .endif
   9                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	
  10                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	                .ifndef VARS
  11                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	                .err
  12                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	                .endif
  13                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	
  14                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	                ; most of these can probably actually be in registers
  15                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	                ; need to write more code and see how they are used.
  16                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	                ; Register allocation:
  17                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	                ; r0-r1 t
  18                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	                ; r2-r3 ?
  19                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	                ; r4    text index (Y). t when text index not needed
  20                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	                ; r5    value of VARS
  21                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	                ; r6-r7 return addresses (r6 for nesting in one place)
  22                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	                ; When r6 is not a nested return address, it is t
  23                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	                .set XAM_OFF,  0
  24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	                .set ST_OFF,   2
  25                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	                .set HV_OFF,   4
  26                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	                .set YSAV_OFF, 6
  27                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	                .set MODE_OFF, 7
  28                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	                .set IN_OFF,   8
  29                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	
  30                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	                ; defn of _start is needed for MegaIng's annotated output
  31                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	                .globl _start
  32                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	_start:
  33                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	                .globl WOZ_RESET
  34 0000 48834C9F                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        	WOZ_RESET:      movh    %rh4, 0x7F
  35 0004 B000                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            	                call    1f
  36 0006 1000                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            	                .word   VARS
  37 0008 1ABC                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            	1:              movx    %rx5, [%rx7]
  38                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	                .ifdef SET_VEC
  39                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	                call    1f
  40                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	1:              .word   DOUBLEFAULT
  41                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	                movx    %rx0, [%rx7]    ; DOUBLEFAULT -> r0
  42                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	                writecr %rx0, 4         ; DOUBLEFAULT -> INT_PC
  43                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	                .endif
  44 000a 8E00                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            	NOTCR:          hlt
